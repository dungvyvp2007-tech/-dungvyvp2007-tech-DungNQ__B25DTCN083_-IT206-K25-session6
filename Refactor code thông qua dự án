#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>

#define MAX_ROOMS 100
#define MAX_BOOKINGS 100

/* ===================== STRUCT ===================== */
typedef struct {
    char roomId[10];
    int type;        // 1,2
    double price;
    int status;      // 0: Trong, 1: Dang o, 2: Bao tri
} Room;

typedef struct {
    char bookId[20];
    char roomId[10];
    char customer[50];
    int days;
    double total;
} Booking;

/* ===================== GLOBAL ===================== */
Room rooms[MAX_ROOMS];
Booking bookings[MAX_BOOKINGS];
int nRoom = 0, nBooking = 0;

/* ===================== UTIL ===================== */
void clearNL(char *s){ s[strcspn(s,"\n")] = 0; }

int inputInt(const char *msg,int min,int max){
    char buf[20]; int x; char *e;
    while(1){
        printf("%s",msg);
        fgets(buf,sizeof(buf),stdin);
        x = strtol(buf,&e,10);
        if(e==buf||(*e&&*e!='\n')){ printf("Nhap sai!\n"); continue; }
        if(x<min||x>max){ printf("Nhap %d-%d!\n",min,max); continue; }
        return x;
    }
}

double inputDouble(const char *msg){
    char buf[30]; double x; char *e;
    while(1){
        printf("%s",msg);
        fgets(buf,sizeof(buf),stdin);
        x = strtod(buf,&e);
        if(e==buf||(*e&&*e!='\n')||x<=0){ printf("Nhap sai!\n"); continue; }
        return x;
    }
}

int findRoom(const char *id){
    for(int i=0;i<nRoom;i++)
        if(strcmp(rooms[i].roomId,id)==0) return i;
    return -1;
}

const char* statusText(int s){
    if(s==0) return "Trong";
    if(s==1) return "Dang o";
    return "Bao tri";
}

/* ===================== SAMPLE ===================== */
void sampleRooms(){
    Room s[]={{"101",1,300000,0},{"102",1,320000,0},{"201",2,450000,0}};
    for(int i=0;i<3;i++) rooms[nRoom++] = s[i];
}

/* ===================== ROOM ===================== */
void addRoom(){
    Room r;
    while(1){
        printf("Ma phong: ");
        fgets(r.roomId,sizeof(r.roomId),stdin); clearNL(r.roomId);
        if(!strlen(r.roomId)||findRoom(r.roomId)!=-1){ printf("Khong hop le!\n"); continue; }
        break;
    }
    r.type = inputInt("Loai (1-2): ",1,2);
    r.price = inputDouble("Gia: ");
    r.status = 0;
    rooms[nRoom++] = r;
    printf("Them thanh cong!\n");
}

void updateRoom(){
    char id[10];
    printf("Ma phong: "); fgets(id,sizeof(id),stdin); clearNL(id);
    int i = findRoom(id);
    if(i==-1){ printf("Khong tim thay!\n"); return; }
    rooms[i].type = inputInt("Loai moi: ",1,2);
    rooms[i].price = inputDouble("Gia moi: ");
    printf("Cap nhat xong!\n");
}

void displayRooms(){
    printf("\nID\tLoai\tGia\tTrang thai\n");
    for(int i=0;i<nRoom;i++)
        printf("%s\t%d\t%.0lf\t%s\n",rooms[i].roomId,rooms[i].type,rooms[i].price,statusText(rooms[i].status));
}

void maintainRoom(){
    char id[10];
    printf("Ma phong: "); fgets(id,sizeof(id),stdin); clearNL(id);
    int i=findRoom(id);
    if(i==-1||rooms[i].status==1){ printf("Khong the thao tac!\n"); return; }
    int c=inputInt("1.Khoa 2.Mo: ",1,2);
    rooms[i].status = (c==1?2:0);
}

/* ===================== BOOKING ===================== */
void checkIn(){
    char id[10];
    printf("Ma phong: "); fgets(id,sizeof(id),stdin); clearNL(id);
    int i=findRoom(id);
    if(i==-1||rooms[i].status!=0){ printf("Phong khong trong!\n"); return; }
    Booking b;
    sprintf(b.bookId,"B%03d",nBooking+1);
    strcpy(b.roomId,id);
    printf("Ten khach: "); fgets(b.customer,sizeof(b.customer),stdin); clearNL(b.customer);
    b.days = inputInt("So ngay: ",1,365);
    b.total = b.days * rooms[i].price;
    bookings[nBooking++] = b;
    rooms[i].status = 1;
    printf("Tong tien: %.0lf\n",b.total);
}

void displayBookings(){
    for(int i=0;i<nBooking;i++)
        printf("%s | %s | %s | %d | %.0lf\n",bookings[i].bookId,bookings[i].roomId,bookings[i].customer,bookings[i].days,bookings[i].total);
}

void checkOutRoom(){
    char id[10];
    printf("Ma phong: "); fgets(id,sizeof(id),stdin); clearNL(id);
    int i=findRoom(id);
    if(i==-1||rooms[i].status!=1){ printf("Khong hop le!\n"); return; }
    rooms[i].status = 0;
    printf("Tra phong xong!\n");
}

/* ===================== MENU ===================== */
void mainMenu(){ printf("\n1.QL phong\n2.QL giao dich\n3.Thoat\n"); }
void subMenu1(){ printf("1.Them 2.Cap nhat 3.Bao tri 4.Hien thi 5.Back\n"); }
void subMenu2(){ printf("1.Check-in 2.Lich su 3.Check-out 4.Back\n"); }

int main(){
    sampleRooms();
    int c;
    do{
        mainMenu();
        c=inputInt("Chon: ",1,3);
        if(c==1){
            int x; do{
                subMenu1();
                x=inputInt("Chon: ",1,5);
                if(x==1) addRoom();
                if(x==2) updateRoom();
                if(x==3) maintainRoom();
                if(x==4) displayRooms();
            }while(x!=5);
        }
        if(c==2){
            int x; do{
                subMenu2();
                x=inputInt("Chon: ",1,4);
                if(x==1) checkIn();
                if(x==2) displayBookings();
                if(x==3) checkOutRoom();
            }while(x!=4);
        }
    }while(c!=3);
    return 0;
}
